<!DOCTYPE html>
<html>
  <head>
    <title>shikkui image uploader</title>
    <meta content="" />
    <meta charset="utf-8" />

    <link href="index.css" rel="stylesheet" />

    <!-- firebase settings -->
    <script src="https://www.gstatic.com/firebasejs/5.10.0/firebase.js"></script>
    <script>
      let userInfo = null;

      // Initialize Firebase
      const config = {
        apiKey: "AIzaSyDozEEmAxyqJU3avAdW_KBommb4HGR5nRk",
        authDomain: "kasgai.firebaseapp.com",
        databaseURL: "https://kasgai.firebaseio.com",
        projectId: "kasgai",
        storageBucket: "kasgai.appspot.com",
        messagingSenderId: "143262592214"
      };
      firebase.initializeApp(config);

      // firebase auth
      const firebaseAuth = new Promise((resolve, reject) => {
        firebase.auth().onAuthStateChanged(user => {
          if (user) {
            resolve(user);
          }
          reject("please login");
        });
      });

      // main logic
      (async () => {
        const result = await Promise.all([firebaseAuth]).catch(error => {
          alert(error);
          return;
        });

        userInfo = result[0];
        fetchAllImages();
      })();
    </script>
    <style>
      .abstract {
        margin: 16px;
      }
      .tile__grid {
        background-color: aqua;
        margin: 16px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        grid-gap: 20px;
        align-items: center;
      }
      .tile__image > img {
        max-width: 100%;
      }
      .tile__image p {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div class="abstract">
      <h1>画像投稿ページ</h1>
      <p>
        投稿する画像のタイトル
        <input type="text" id="filename" />
      </p>
      <p>
        <input type="file" id="uploadfile" />
        <button onclick="upload()">upload</button>
      </p>
    </div>
    <div class="tile__grid" id="tile__image--root"></div>
    <script>
      const projectId = window.location.search.replace(/\?id=/, "");

      const fetchAllImages = () => {
        // check user id
        if (userInfo.uid == null) {
          alert("please login again");
          return;
        }

        const imageTitleList = firebase
          .database()
          .ref(`/projects/${projectId}/shikkui`);

        imageTitleList.on("value", snapshot => {
          if (snapshot.val() != null) {
            // clear previous image element
            const target = document.getElementById("tile__image--root");
            while (target.firstChild) {
              target.removeChild(target.firstChild);
            }

            snapshot.val().forEach(imageTitle => {
              const storageRef = firebase
                .storage()
                .ref(`/shikkui_images/${projectId}/${imageTitle}`);

              storageRef
                .getDownloadURL()
                .then(url => {
                  document
                    .getElementById("tile__image--root")
                    .appendChild(createTileImage(url, imageTitle));
                })
                .catch(error => {
                  console.error(error);
                });
            });
          }
        });
      };

      const createTileImage = (src, alt) => {
        const div = document.createElement("div");
        div.classList.add("tile__image");

        const image = createImage(src, alt);
        div.appendChild(image);

        const p = document.createElement("p");
        p.textContent = alt;
        div.appendChild(p);

        return div;
      };
      const createImage = (src, alt) => {
        const img = document.createElement("img");
        img.src = src;
        if (alt != null) {
          img.alt = alt;
        }
        return img;
      };

      const upload = () => {
        // check filename
        if (filename.value === "") {
          alert("please set filename");
          return;
        }
        const uploadFileName = filename.value;

        // check upload file
        if (uploadfile.files.length === 0) {
          alert("please set image");
          return;
        }
        const file = uploadfile.files[0];

        // check user id
        if (userInfo.uid == null) {
          alert("please login again");
          return;
        }

        // upload file
        const storageRef = firebase
          .storage()
          .ref(`/shikkui_images/${projectId}/${uploadFileName}`);
        storageRef
          .put(file)
          .then(snapshot => {
            // add filename list
            const imageTitleList = firebase
              .database()
              .ref(`/projects/${projectId}/shikkui`);

            imageTitleList.on("value", snapshot => {
              const beforeImages = snapshot.val() || [];
              if (!beforeImages.includes(uploadFileName)) {
                imageTitleList.set([...snapshot.val(), uploadFileName]);
              }
            });
          })
          .catch(error => {
            alert(`error : ${error}`);
          });
      };
    </script>
  </body>
</html>
